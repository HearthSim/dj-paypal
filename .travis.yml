version: ~> 1.0
os: linux
language: python
python: "3.9"
addons:
  postgresql: "11"

env:
  - TOXENV=py39-django31
  - TOXENV=py39-djangomaster
  - TOXENV=checkmigrations
  - TOXENV=flake8

before_install:
  - sudo apt-get update
  - sudo apt-get --yes remove postgresql\*
  - sudo apt-get install -y postgresql-11 postgresql-client-11
  - sudo cp /etc/postgresql/{9.6,11}/main/pg_hba.conf
  - sudo sed -i 's/port = 5433/port = 5432/' /etc/postgresql/11/main/postgresql.conf
  - sudo service postgresql restart 11

install:
  - pip install --upgrade pip setuptools wheel
  - pip install tox

before_script:
  - psql -U postgres -c 'CREATE DATABASE "test_djpaypal";'

script:
  - tox

stages:
  - name: test
  - name: deploy
    if: tag IS present

jobs:
  allow_failures:
    - env: TOXENV=py39-djangomaster
  fast_finish: true
  include:
    - stage: deploy
      install: pip install poetry
      script: poetry build
      deploy:
        provider: script
        script: poetry publish
        skip_cleanup: true
        on:
          tags: true
